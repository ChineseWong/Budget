<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Budget">
<meta name="theme-color" content="#09090b">
<meta name="mobile-web-app-capable" content="yes">
<title>Budget</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<style>
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html { height:100%; overflow:hidden; }
  body { background:#09090b; overflow-x:hidden; overflow-y:auto; height:100%; -webkit-overflow-scrolling:touch; overscroll-behavior-y:contain; }
  ::-webkit-scrollbar { display:none; }
  input, select, button, textarea { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif; font-size:16px; }
  input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }
  button { -webkit-user-select:none; user-select:none; touch-action:manipulation; }
  button:active { opacity:0.7 !important; transform:scale(0.97); transition:all 0.08s; }
  details summary { -webkit-user-select:none; user-select:none; touch-action:manipulation; min-height:44px; display:flex; align-items:center; }
  .recharts-tooltip-label { color:#fafafa !important; }
  .recharts-tooltip-item { color:#fafafa !important; }
  .recharts-tooltip-item-name { color:#a1a1aa !important; }
  .recharts-tooltip-item-value { color:#fafafa !important; font-weight:600; }
  .recharts-default-tooltip { background:#18181b !important; border:1px solid #27272a !important; border-radius:10px !important; padding:10px 14px !important; }
  select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' fill='none' stroke='%2371717a' stroke-width='1.5'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; padding-right:32px !important; }
  @supports(padding: env(safe-area-inset-top)) {
    body { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }
  }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.7.2/Recharts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useCallback, useMemo } = React;
const { PieChart, Pie, Cell, BarChart, Bar, LineChart, Line, AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, Legend } = Recharts;

const fmt = n => { if (n == null || isNaN(n)) return "$0.00"; const a = Math.abs(n), s = a.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 }); return n < 0 ? `-$${s}` : `$${s}`; };
const pct = n => ((n || 0) * 100).toFixed(1) + "%";
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
const dFmt = d => new Date(d + "T12:00:00").toLocaleDateString("en-US", { month: "short", day: "numeric" });
const mIdx = d => new Date(d + "T12:00:00").getMonth();
const MN = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
const td = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`; };

const CATS = ["Activities", "Bets", "Car Payment", "Cars", "Doctor", "Food", "Fun", "Games", "Gas", "Gifts", "Insurance", "Personal", "Phone", "Shopping", "Subscriptions", "Wins/Losses"];
const FIX = ["Subscriptions", "Insurance", "Car Payment", "Phone", "Fixed", "Gas"];
const DSC = ["Activities", "Bets", "Cars", "Doctor", "Food", "Fun", "Games", "Gifts", "Personal", "Shopping"];
const SC = ["Subscriptions", "Insurance", "Car Payment", "Phone", "Gas", "Fixed"];

/* ─── palette: monochrome-forward with selective color ─── */
const T = {
  bg: "#09090b", s1: "#18181b", s2: "#27272a", s3: "#3f3f46",
  b: "#27272a", bSub: "#1c1c1f",
  w: "#fafafa", w2: "#a1a1aa", w3: "#71717a", w4: "#52525b",
  blue: "#60a5fa", green: "#34d399", red: "#f87171", amber: "#fbbf24", purple: "#a78bfa", cyan: "#67e8f9", pink: "#f472b6", orange: "#fb923c",
  greenDim: "#052e16", redDim: "#450a0a",
};
const PC = ["#60a5fa", "#34d399", "#fbbf24", "#f87171", "#a78bfa", "#67e8f9", "#f472b6", "#fb923c", "#a3e635", "#818cf8", "#2dd4bf", "#e879f9", "#fb7185", "#38bdf8", "#facc15"];
const IK = ["k", "h", "r", "b", "y"];
const IL = { k: "401k", h: "HSA", r: "Roth IRA", b: "Bitcoin", y: "HYSA/CMA" };
const GL = { k: "401k", h: "HSA", r: "Roth IRA", b: "Bitcoin", e: "Emergency Fund" };
const GIM = { k: "k", h: "h", r: "r", b: "b", e: "y" };

/* ─── seed ─── */
const S_PC = [];
const S_SP = [];
const S_ST = { investPcts: { k: 0, h: 0, r: 0, b: 0, y: 0 }, goalTargets: { k: 0, h: 0, r: 0, b: 0, e: 0 } };
const S_SUB = [];
const S_NW = { assets: [{ id: "a1", name: "Retirement", bal: 0 }, { id: "a2", name: "Investments", bal: 0 }, { id: "a3", name: "Savings", bal: 0 }, { id: "a4", name: "Checking", bal: 0 }], liabilities: [{ id: "l1", name: "Loans", bal: 0 }, { id: "l2", name: "Credit Card", bal: 0 }] };
const S_NWH = [];

const K = { pc: "bw3-pc", sp: "bw3-sp", st: "bw3-st", sub: "bw3-sub", nw: "bw3-nw", nwh: "bw3-nwh", init: "bw3-init" };
function loadAll() {
  try {
    const ck = localStorage.getItem(K.init);
    if (!ck) { [K.pc,K.sp,K.st,K.sub,K.nw,K.nwh].forEach((k,i)=>localStorage.setItem(k,JSON.stringify([S_PC,S_SP,S_ST,S_SUB,S_NW,S_NWH][i]))); localStorage.setItem(K.init,"1"); return Promise.resolve({pc:S_PC,sp:S_SP,st:S_ST,sub:S_SUB,nw:S_NW,nwh:S_NWH}); }
    const g=k=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):null;}catch{return null;}};
    return Promise.resolve({pc:g(K.pc)||S_PC,sp:g(K.sp)||S_SP,st:g(K.st)||S_ST,sub:g(K.sub)||S_SUB,nw:g(K.nw)||S_NW,nwh:g(K.nwh)||S_NWH});
  } catch { return Promise.resolve({pc:S_PC,sp:S_SP,st:S_ST,sub:S_SUB,nw:S_NW,nwh:S_NWH}); }
}
function sv(k, d) { try { localStorage.setItem(k, JSON.stringify(d)); } catch {} }

/* ─── UI ─── */
const iS = { width: "100%", padding: "12px 14px", borderRadius: 10, border: `1px solid ${T.b}`, background: T.bg, color: T.w, fontSize: 16, fontFamily: "inherit", boxSizing: "border-box", outline: "none", WebkitAppearance: "none", minHeight: 48 };
const bS = (c, o, sm, fl, dis) => ({ padding: sm ? "8px 14px" : "14px 18px", borderRadius: 10, border: o ? `1.5px solid ${c}` : "none", background: o ? "transparent" : dis ? T.s3 : c, color: o ? c : "#fff", fontSize: sm ? 12 : 14, fontWeight: 600, cursor: dis ? "default" : "pointer", opacity: dis ? 0.4 : 1, width: fl ? "100%" : "auto", fontFamily: "inherit", letterSpacing: 0.2, minHeight: sm ? 36 : 48, touchAction: "manipulation", WebkitUserSelect: "none" });

function Inp({ label, value, onChange, type = "text", ph, sx }) {
  return <div style={{ marginBottom: 14, ...sx }}>{label && <div style={{ fontSize: 11, color: T.w3, fontWeight: 600, marginBottom: 5, letterSpacing: 0.8, textTransform: "uppercase" }}>{label}</div>}<input value={value} onChange={e => onChange(e.target.value)} type={type} placeholder={ph} step={type === "number" ? "any" : undefined} style={iS} /></div>;
}
function Sel({ label, value, onChange, opts }) {
  return <div style={{ marginBottom: 14 }}>{label && <div style={{ fontSize: 11, color: T.w3, fontWeight: 600, marginBottom: 5, letterSpacing: 0.8, textTransform: "uppercase" }}>{label}</div>}<select value={value} onChange={e => onChange(e.target.value)} style={{ ...iS, WebkitAppearance: "none" }}>{opts.map(o => <option key={o} value={o}>{o}</option>)}</select></div>;
}
const Cd = ({ children, sx, onClick }) => <div onClick={onClick} style={{ background: T.s1, borderRadius: 14, padding: 18, border: `1px solid ${T.bSub}`, ...sx }}>{children}</div>;
const SH = ({ children }) => <div style={{ fontSize: 11, fontWeight: 700, color: T.w4, textTransform: "uppercase", letterSpacing: 1.8, marginBottom: 10, marginTop: 14 }}>{children}</div>;
const PB = ({ p, color, h = 6 }) => <div style={{ width: "100%", height: h, background: T.s2, borderRadius: h, overflow: "hidden" }}><div style={{ width: `${Math.min(Math.max(p || 0, 0), 1) * 100}%`, height: "100%", background: color, borderRadius: h, transition: "width 0.6s ease" }} /></div>;
const tt = { background: T.s1, border: `1px solid ${T.b}`, borderRadius: 10, color: T.w, fontSize: 12, padding: "10px 14px" };
const ttL = { color: T.w };
const ttI = { color: T.w, fontWeight: 600 };

function Modal({ open, onClose, title, children }) {
  const [dragY, setDragY] = React.useState(0);
  const [startY, setStartY] = React.useState(null);
  if (!open) return null;
  const onTS = e => { setStartY(e.touches[0].clientY); };
  const onTM = e => { if (startY !== null) { const dy = Math.max(0, e.touches[0].clientY - startY); setDragY(dy); } };
  const onTE = () => { if (dragY > 120) onClose(); setDragY(0); setStartY(null); };
  return <div style={{ position: "fixed", inset: 0, zIndex: 1000, display: "flex", alignItems: "flex-end", justifyContent: "center" }} onClick={onClose}>
    <div style={{ position: "absolute", inset: 0, background: `rgba(0,0,0,${0.7 - dragY * 0.003})`, backdropFilter: "blur(4px)", transition: dragY ? "none" : "background 0.3s" }} />
    <div onClick={e => e.stopPropagation()} onTouchStart={onTS} onTouchMove={onTM} onTouchEnd={onTE} style={{ position: "relative", width: "100%", maxWidth: 480, maxHeight: "88vh", background: T.s1, borderRadius: "20px 20px 0 0", padding: "22px 20px 34px", overflowY: "auto", WebkitOverflowScrolling: "touch", transform: `translateY(${dragY}px)`, transition: dragY ? "none" : "transform 0.3s ease" }}>
      <div style={{ width: 36, height: 4, background: T.s3, borderRadius: 2, margin: "0 auto 18px", touchAction: "none" }} />
      <div style={{ fontSize: 18, fontWeight: 700, marginBottom: 18, letterSpacing: -0.3 }}>{title}</div>
      {children}
    </div>
  </div>;
}

/* ═══════ APP ═══════ */
function App() {
  const [loading, setLoading] = useState(true);
  const [tab, setTab] = useState(0);
  const [pc, setPc] = useState([]);
  const [sp, setSp] = useState([]);
  const [st, setSt] = useState(S_ST);
  const [sub, setSub] = useState([]);
  const [nw, setNw] = useState(S_NW);
  const [nwh, setNwh] = useState([]);
  const [modal, setModal] = useState(null);

  useEffect(() => { loadAll().then(d => { setPc(d.pc); setSp(d.sp); setSt(d.st); setSub(d.sub); setNw(d.nw); setNwh(d.nwh); setLoading(false); }); }, []);
  const sPC = useCallback(d => { setPc(d); sv(K.pc, d); }, []);
  const sSP = useCallback(d => { setSp(d); sv(K.sp, d); }, []);
  const sST = useCallback(d => { setSt(d); sv(K.st, d); }, []);
  const sSUB = useCallback(d => { setSub(d); sv(K.sub, d); }, []);
  const sNW = useCallback(d => { setNw(d); sv(K.nw, d); }, []);
  const sNWH = useCallback(d => { setNwh(d); sv(K.nwh, d); }, []);

  /* ─── pay period calc (pid-based matching like spreadsheet) ─── */
  const ppData = useMemo(() => {
    const sorted = [...pc].sort((a, b) => a.date.localeCompare(b.date));
    const noWL = sp.filter(s => s.cat !== "Wins/Losses");
    const allPeriods = sorted.map(p => p.period);
    let running = 0;
    return sorted.map((p, i) => {
      // Spending assignment: match by pid if set, otherwise by date range
      const periodSpend = noWL.filter(s => {
        if (s.pid > 0) {
          if (allPeriods.includes(s.pid)) return s.pid === p.period;
          return i === sorted.length - 1; // orphaned pid goes to last period
        }
        const start = i === 0 ? "2000-01-01" : p.date;
        const end = i < sorted.length - 1 ? sorted[i + 1].date : "2099-12-31";
        return s.date >= start && s.date < end;
      });
      const fixS = periodSpend.filter(e => FIX.includes(e.cat)).reduce((a, e) => a + e.amt, 0);
      const discS = periodSpend.filter(e => DSC.includes(e.cat)).reduce((a, e) => a + e.amt, 0);
      const totInv = IK.reduce((a, k) => a + (p.inv[k] || 0), 0);
      const discBudget = p.gross - totInv - fixS;
      if (i > 0) running = running + discBudget - discS;
      // PP1 stays at 0 (matches spreadsheet)
      return { ...p, fixS, discS, totalSpend: fixS + discS, totInv, discBudget, discRemaining: running, periodSpend };
    });
  }, [pc, sp]);

  /* ─── derived ─── */
  const D = useMemo(() => {
    const aPC = pc.filter(p => p.gross > 0);
    const gYTD = aPC.reduce((s, p) => s + p.gross, 0);
    const inv = { k: 0, h: 0, r: 0, b: 0, y: 0 };
    aPC.forEach(p => IK.forEach(k => { inv[k] += (p.inv[k] || 0); }));
    const tInv = Object.values(inv).reduce((a, b) => a + b, 0);
    const noWL = sp.filter(s => s.cat !== "Wins/Losses");
    const tSp = noWL.reduce((s, e) => s + e.amt, 0);
    const byCat = {};
    noWL.forEach(e => { byCat[e.cat] = (byCat[e.cat] || 0) + e.amt; });
    const catArr = Object.entries(byCat).sort((a, b) => b[1] - a[1]).map(([cat, total]) => ({ cat, total, pct: tSp > 0 ? total / tSp : 0 }));
    const monthly = MN.map((m, mi) => {
      const mS = noWL.filter(e => mIdx(e.date) === mi);
      const mP = aPC.filter(p => mIdx(p.date) === mi);
      const inc = mP.reduce((s, p) => s + p.gross, 0);
      const invested = mP.reduce((s, p) => s + Object.values(p.inv).reduce((a, b) => a + b, 0), 0);
      const fix = mS.filter(e => FIX.includes(e.cat)).reduce((s, e) => s + e.amt, 0);
      const disc = mS.filter(e => DSC.includes(e.cat)).reduce((s, e) => s + e.amt, 0);
      return { month: m, income: inc, invested, fixed: fix, disc, total: fix + disc, cf: inc - invested - fix - disc, pp: mP.length };
    });
    const wl = sp.filter(s => s.cat === "Wins/Losses").reduce((s, e) => s + e.amt, 0);
    const tA = nw.assets.reduce((s, a) => s + a.bal, 0);
    const tL = nw.liabilities.reduce((s, l) => s + l.bal, 0);
    const dR = ppData.length > 0 ? ppData[ppData.length - 1].discRemaining : 0;
    return { gYTD, inv, tInv, tSp, sRate: gYTD > 0 ? tInv / gYTD : 0, catArr, monthly, wl, tA, tL, netW: tA - tL, dR, nCF: gYTD - tInv - tSp };
  }, [pc, sp, nw, ppData]);

  const addPC = d => sPC([...pc, { ...d, id: uid() }].sort((a, b) => a.date.localeCompare(b.date)));
  const editPC = (id, u) => sPC(pc.map(p => p.id === id ? { ...p, ...u } : p));
  const delPC = id => sPC(pc.filter(p => p.id !== id));
  const addSP = d => sSP([...sp, { ...d, id: uid() }]);
  const editSP = (id, u) => sSP(sp.map(e => e.id === id ? { ...e, ...u } : e));
  const delSP = id => sSP(sp.filter(e => e.id !== id));

  const exportJSON = () => { const b = new Blob([JSON.stringify({ paychecks: pc, spending: sp, settings: st, subscriptions: sub, netWorth: nw, netWorthHistory: nwh }, null, 2)], { type: "application/json" }); const u = URL.createObjectURL(b); const a = document.createElement("a"); a.href = u; a.download = `bwong-budget-${td()}.json`; a.click(); URL.revokeObjectURL(u); };
  const exportCSV = () => { const rows = [["Date", "Category", "Amount", "Note"], ...sp.filter(s => s.cat !== "Wins/Losses").sort((a, b) => a.date.localeCompare(b.date)).map(e => [e.date, e.cat, e.amt, e.note || ""])]; const csv = rows.map(r => r.map(c => typeof c === "string" && c.includes(",") ? `"${c}"` : c).join(",")).join("\n"); const b = new Blob([csv], { type: "text/csv" }); const u = URL.createObjectURL(b); const a = document.createElement("a"); a.href = u; a.download = `bwong-spending-${td()}.csv`; a.click(); URL.revokeObjectURL(u); };
  const saveNWH = u => { sNW(u); const tA = u.assets.reduce((s, a) => s + a.bal, 0), tL = u.liabilities.reduce((s, l) => s + l.bal, 0); const snap = { date: td(), assets: tA, liabilities: tL, net: tA - tL }; sNWH([...nwh.filter(h => h.date !== td()), snap].sort((a, b) => a.date.localeCompare(b.date))); };

  const tabs = ["Overview", "Monthly", "Pay Periods", "Spending", "Goals", "Bills", "Net Worth", "Settings"];

  if (loading) return <div style={{ minHeight: "100vh", background: T.bg, display: "flex", alignItems: "center", justifyContent: "center" }}><div style={{ color: T.w3, fontSize: 14 }}>Loading...</div></div>;

  return (
    <div style={{ minHeight: "100vh", background: T.bg, color: T.w, fontFamily: "-apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif", maxWidth: 480, margin: "0 auto", paddingBottom: 80, WebkitFontSmoothing: "antialiased" }}>
      <div style={{ padding: "24px 20px 10px", position: "sticky", top: 0, background: T.bg, zIndex: 100 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline" }}>
          <div><div style={{ fontSize: 20, fontWeight: 700, letterSpacing: -0.5 }}>Budget</div><div style={{ fontSize: 12, color: T.w4, marginTop: 2 }}>2026</div></div>
          <div style={{ display: "flex", gap: 8 }}>
            <button style={{ ...bS(T.green, false, true), padding: "10px 16px", minHeight: 40 }} onClick={() => setModal("addPC")}>+ Pay</button>
            <button style={{ ...bS(T.s3, false, true), padding: "10px 16px", minHeight: 40, color: T.w2 }} onClick={() => setModal("addSP")}>+ Spend</button>
          </div>
        </div>
      </div>
      <div style={{ display: "flex", gap: 6, padding: "8px 20px 6px", overflowX: "auto", scrollbarWidth: "none", WebkitOverflowScrolling: "touch" }}>
        {tabs.map((t, i) => <button key={i} onClick={() => setTab(i)} style={{ padding: "10px 14px", borderRadius: 8, border: "none", fontSize: 12, fontWeight: 600, cursor: "pointer", flexShrink: 0, background: tab === i ? T.w : "transparent", color: tab === i ? T.bg : T.w4, fontFamily: "inherit", transition: "all 0.15s", minHeight: 44 }}>{t}</button>)}
      </div>
      <div style={{ padding: "12px 20px 20px" }}>
        {tab === 0 && <OverviewTab D={D} st={st} ppData={ppData} />}
        {tab === 1 && <MonthlyTab D={D} pc={pc} setModal={setModal} />}
        {tab === 2 && <PayPeriodTab ppData={ppData} setModal={setModal} />}
        {tab === 3 && <SpendingTab D={D} sp={sp} setModal={setModal} pc={pc} />}
        {tab === 4 && <GoalsTab D={D} st={st} />}
        {tab === 5 && <BillsTab sub={sub} setModal={setModal} />}
        {tab === 6 && <NetWorthTab nw={nw} D={D} nwh={nwh} setModal={setModal} />}
        {tab === 7 && <SettingsTab st={st} sST={sST} exportJSON={exportJSON} exportCSV={exportCSV} />}
      </div>

      <AddPCModal open={modal === "addPC"} onClose={() => setModal(null)} onSave={d => { addPC(d); setModal(null); }} st={st} nextP={pc.length > 0 ? Math.max(...pc.map(p => p.period)) + 1 : 1} />
      <EditPCModal open={modal?.t === "ePC"} data={modal?.t === "ePC" ? modal.d : null} onClose={() => setModal(null)} onSave={(id, u) => { editPC(id, u); setModal(null); }} onDel={id => { delPC(id); setModal(null); }} />
      <AddSPModal open={modal === "addSP"} onClose={() => setModal(null)} onSave={d => { addSP(d); setModal(null); }} pc={pc} />
      <EditSPModal open={modal?.t === "eSP"} data={modal?.t === "eSP" ? modal.d : null} onClose={() => setModal(null)} onSave={(id, u) => { editSP(id, u); setModal(null); }} onDel={id => { delSP(id); setModal(null); }} pc={pc} />
      <AddSubModal open={modal === "addSub"} onClose={() => setModal(null)} onSave={d => { sSUB([...sub, { ...d, id: uid() }]); setModal(null); }} />
      <EditSubModal open={modal?.t === "eSub"} data={modal?.t === "eSub" ? modal.d : null} onClose={() => setModal(null)} onSave={(id, u) => { sSUB(sub.map(s => s.id === id ? { ...s, ...u } : s)); setModal(null); }} onDel={id => { sSUB(sub.filter(s => s.id !== id)); setModal(null); }} />
      <EditNWModal open={modal?.t === "eNW"} items={modal?.t === "eNW" ? modal.items : null} kind={modal?.t === "eNW" ? modal.kind : null} onClose={() => setModal(null)} onSave={u => { saveNWH(u); setModal(null); }} nw={nw} />
    </div>
  );
}

/* ═══════ MODALS ═══════ */
function AddPCModal({ open, onClose, onSave, st, nextP }) {
  const [date, setDate] = useState(td()); const [gross, setGross] = useState(""); const [auto, setAuto] = useState(true); const [inv, setInv] = useState({ k: "", h: "", r: "", b: "", y: "" });
  useEffect(() => { if (open) { setDate(td()); setGross(""); setAuto(true); setInv({ k: "", h: "", r: "", b: "", y: "" }); } }, [open]);
  const g = parseFloat(gross) || 0;
  const aI = {}; IK.forEach(k => { aI[k] = +(g * (st.investPcts[k] || 0)).toFixed(2); });
  const fI = auto ? aI : {}; if (!auto) IK.forEach(k => { fI[k] = parseFloat(inv[k]) || 0; });
  const tI = Object.values(fI).reduce((a, b) => a + b, 0);
  return <Modal open={open} onClose={onClose} title="Add Paycheck">
    <Inp label="Date" value={date} onChange={setDate} type="date" />
    <Inp label="Gross Pay" value={gross} onChange={setGross} type="number" ph="0.00" />
    <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 14 }}><input type="checkbox" checked={auto} onChange={() => setAuto(!auto)} style={{ accentColor: T.blue }} /><span style={{ fontSize: 13, color: T.w3 }}>Auto-calculate from %</span></div>
    {!auto && <div style={{ background: T.bg, borderRadius: 12, padding: 14, marginBottom: 14 }}>{IK.map(k => <Inp key={k} label={IL[k]} value={inv[k]} onChange={v => setInv({ ...inv, [k]: v })} type="number" ph="0.00" />)}</div>}
    {g > 0 && <Cd sx={{ marginBottom: 16, background: T.bg }}>
      {IK.map(k => <div key={k} style={{ display: "flex", justifyContent: "space-between", padding: "4px 0", fontSize: 13, color: T.w3 }}><span>{IL[k]}</span><span style={{ color: T.green, fontWeight: 600 }}>{fmt(fI[k])}</span></div>)}
      <div style={{ borderTop: `1px solid ${T.b}`, marginTop: 8, paddingTop: 8, display: "flex", justifyContent: "space-between", fontSize: 13, fontWeight: 700 }}><span>Invested</span><span style={{ color: T.green }}>{fmt(tI)}</span></div>
      <div style={{ display: "flex", justifyContent: "space-between", fontSize: 13, color: T.amber, marginTop: 4 }}><span>Remaining</span><span>{fmt(g - tI)}</span></div>
    </Cd>}
    <button style={bS(T.green, false, false, true, !date || g < 0)} onClick={() => { if (date && g >= 0) onSave({ date, period: nextP, gross: g, inv: fI }); }} disabled={!date || g < 0}>Save Paycheck</button>
  </Modal>;
}

function EditPCModal({ open, data, onClose, onSave, onDel }) {
  const [date, setDate] = useState(""); const [gross, setGross] = useState(""); const [inv, setInv] = useState({ k: "", h: "", r: "", b: "", y: "" });
  useEffect(() => { if (data) { setDate(data.date); setGross(String(data.gross)); const i = {}; IK.forEach(k => { i[k] = String(data.inv[k] || 0); }); setInv(i); } }, [data]);
  if (!data) return null;
  return <Modal open={open} onClose={onClose} title="Edit Paycheck">
    <Inp label="Date" value={date} onChange={setDate} type="date" /><Inp label="Gross Pay" value={gross} onChange={setGross} type="number" />
    <div style={{ background: T.bg, borderRadius: 12, padding: 14, marginBottom: 14 }}>{IK.map(k => <Inp key={k} label={IL[k]} value={inv[k]} onChange={v => setInv({ ...inv, [k]: v })} type="number" />)}</div>
    <div style={{ display: "flex", gap: 10 }}><button style={bS(T.red, true, false, true)} onClick={() => onDel(data.id)}>Delete</button><button style={bS(T.green, false, false, true)} onClick={() => { const fi = {}; IK.forEach(k => { fi[k] = parseFloat(inv[k]) || 0; }); onSave(data.id, { date, gross: parseFloat(gross) || 0, inv: fi }); }}>Save</button></div>
  </Modal>;
}

function AddSPModal({ open, onClose, onSave, pc }) {
  const [date, setDate] = useState(td()); const [cat, setCat] = useState("Food"); const [amt, setAmt] = useState(""); const [note, setNote] = useState(""); const [pid, setPid] = useState(0);
  useEffect(() => { if (open) { setDate(td()); setCat("Food"); setAmt(""); setNote(""); setPid(pc.length > 0 ? Math.max(...pc.map(p => p.period)) : 0); } }, [open, pc]);
  const periods = pc.map(p => p.period).sort((a, b) => b - a);
  return <Modal open={open} onClose={onClose} title="Add Spending">
    <Inp label="Date" value={date} onChange={setDate} type="date" /><Sel label="Category" value={cat} onChange={setCat} opts={CATS} />
    <Inp label="Amount" value={amt} onChange={setAmt} type="number" ph="0.00" />
    {periods.length > 0 && <Sel label="Pay Period" value={pid} onChange={v => setPid(parseInt(v))} opts={periods.map(String)} />}
    <Inp label="Note (optional)" value={note} onChange={setNote} ph="What was this for?" />
    <button style={bS(T.green, false, false, true, !parseFloat(amt))} onClick={() => { if (parseFloat(amt) && date) onSave({ date, cat, amt: parseFloat(amt), note, pid }); }} disabled={!parseFloat(amt)}>Add Entry</button>
  </Modal>;
}

function EditSPModal({ open, data, onClose, onSave, onDel, pc }) {
  const [date, setDate] = useState(""); const [cat, setCat] = useState("Food"); const [amt, setAmt] = useState(""); const [note, setNote] = useState(""); const [pid, setPid] = useState(0);
  useEffect(() => { if (data) { setDate(data.date); setCat(data.cat); setAmt(String(data.amt)); setNote(data.note || ""); setPid(data.pid || 0); } }, [data]);
  if (!data) return null;
  const periods = pc.map(p => p.period).sort((a, b) => b - a);
  return <Modal open={open} onClose={onClose} title="Edit Entry">
    <Inp label="Date" value={date} onChange={setDate} type="date" /><Sel label="Category" value={cat} onChange={setCat} opts={CATS} />
    <Inp label="Amount" value={amt} onChange={setAmt} type="number" />
    {periods.length > 0 && <Sel label="Pay Period" value={pid} onChange={v => setPid(parseInt(v))} opts={[...periods.map(String), "0"]} />}
    <Inp label="Note" value={note} onChange={setNote} />
    <div style={{ display: "flex", gap: 10 }}><button style={bS(T.red, true, false, true)} onClick={() => onDel(data.id)}>Delete</button><button style={bS(T.green, false, false, true)} onClick={() => onSave(data.id, { date, cat, amt: parseFloat(amt) || 0, note, pid })}>Save</button></div>
  </Modal>;
}

function AddSubModal({ open, onClose, onSave }) {
  const [name, setName] = useState(""); const [cost, setCost] = useState(""); const [cat, setCat] = useState("Subscriptions");
  useEffect(() => { if (open) { setName(""); setCost(""); setCat("Subscriptions"); } }, [open]);
  return <Modal open={open} onClose={onClose} title="Add Subscription">
    <Inp label="Name" value={name} onChange={setName} ph="e.g. Netflix" /><Inp label="Monthly Cost" value={cost} onChange={setCost} type="number" ph="0.00" />
    <Sel label="Category" value={cat} onChange={setCat} opts={SC} />
    <button style={bS(T.green, false, false, true, !name || !parseFloat(cost))} onClick={() => { if (name && parseFloat(cost)) onSave({ name, cost: parseFloat(cost), cat }); }} disabled={!name || !parseFloat(cost)}>Add</button>
  </Modal>;
}

function EditSubModal({ open, data, onClose, onSave, onDel }) {
  const [name, setName] = useState(""); const [cost, setCost] = useState(""); const [cat, setCat] = useState("Subscriptions");
  useEffect(() => { if (data) { setName(data.name); setCost(String(data.cost)); setCat(data.cat); } }, [data]);
  if (!data) return null;
  return <Modal open={open} onClose={onClose} title="Edit Subscription">
    <Inp label="Name" value={name} onChange={setName} /><Inp label="Monthly Cost" value={cost} onChange={setCost} type="number" />
    <Sel label="Category" value={cat} onChange={setCat} opts={SC} />
    <div style={{ display: "flex", gap: 10 }}><button style={bS(T.red, true, false, true)} onClick={() => onDel(data.id)}>Delete</button><button style={bS(T.green, false, false, true)} onClick={() => onSave(data.id, { name, cost: parseFloat(cost) || 0, cat })}>Save</button></div>
  </Modal>;
}

function EditNWModal({ open, items, kind, onClose, onSave, nw }) {
  const [rows, setRows] = useState([]);
  useEffect(() => { if (items) setRows(items.map(d => ({ ...d, bal: String(d.bal) }))); }, [items]);
  if (!items) return null;
  return <Modal open={open} onClose={onClose} title={`Edit ${kind === "assets" ? "Assets" : "Liabilities"}`}>
    {rows.map((r, i) => <div key={r.id || i} style={{ display: "flex", gap: 8, marginBottom: 10, alignItems: "flex-end" }}>
      <Inp label={i === 0 ? "Name" : undefined} value={r.name} onChange={v => { const n = [...rows]; n[i] = { ...n[i], name: v }; setRows(n); }} sx={{ flex: 1, marginBottom: 0 }} />
      <Inp label={i === 0 ? "Balance" : undefined} value={r.bal} onChange={v => { const n = [...rows]; n[i] = { ...n[i], bal: v }; setRows(n); }} type="number" sx={{ flex: 1, marginBottom: 0 }} />
      <button style={{ ...bS(T.red, true, true), flexShrink: 0, height: 40 }} onClick={() => setRows(rows.filter((_, j) => j !== i))}>✕</button>
    </div>)}
    <button style={{ ...bS(T.blue, true, true), marginBottom: 16 }} onClick={() => setRows([...rows, { id: uid(), name: "", bal: "0" }])}>+ Add</button>
    <button style={bS(T.green, false, false, true)} onClick={() => { const p = rows.filter(r => r.name).map(r => ({ ...r, bal: parseFloat(r.bal) || 0 })); onSave(kind === "assets" ? { ...nw, assets: p } : { ...nw, liabilities: p }); }}>Save</button>
  </Modal>;
}

/* ═══════ TABS ═══════ */
function OverviewTab({ D, st, ppData }) {
  const invArr = IK.map((k, i) => ({ name: IL[k], ytd: D.inv[k], pctT: st.investPcts[k] || 0 }));
  const invPie = invArr.filter(i => i.ytd > 0).map(i => ({ name: i.name, value: i.ytd }));
  const remC = D.dR >= 0 ? T.green : T.red;
  return <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
    {/* Discretionary banner */}
    <Cd sx={{ borderColor: D.dR >= 0 ? T.green + "30" : T.red + "30" }}>
      <div style={{ fontSize: 11, color: T.w4, fontWeight: 600, letterSpacing: 1, textTransform: "uppercase" }}>Discretionary Remaining</div>
      <div style={{ fontSize: 32, fontWeight: 800, color: remC, letterSpacing: -1, marginTop: 4 }}>{fmt(D.dR)}</div>
      <div style={{ fontSize: 12, color: T.w4, marginTop: 4 }}>Rolling balance across pay periods</div>
    </Cd>

    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
      {[["Income", D.gYTD, T.w], ["Invested", D.tInv, T.green], ["Spent", D.tSp, T.red], ["Cash Flow", D.nCF, D.nCF >= 0 ? T.green : T.red]].map(([l, v, c], i) =>
        <Cd key={i} sx={{ padding: 14 }}><div style={{ fontSize: 11, color: T.w4, fontWeight: 500 }}>{l}</div><div style={{ fontSize: 18, fontWeight: 700, color: c, marginTop: 4, letterSpacing: -0.3 }}>{fmt(v)}</div></Cd>
      )}
    </div>

    <Cd>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}><span style={{ fontSize: 12, color: T.w3 }}>Savings Rate</span><span style={{ fontSize: 22, fontWeight: 800, color: T.green }}>{pct(D.sRate)}</span></div>
      <PB p={D.sRate} color={T.green} h={6} />
    </Cd>

    <SH>Investments</SH>
    <Cd>
      {invPie.length > 0 && <ResponsiveContainer width="100%" height={160}><PieChart><Pie data={invPie} cx="50%" cy="50%" innerRadius={42} outerRadius={70} dataKey="value" stroke="none">{invPie.map((_, i) => <Cell key={i} fill={PC[i]} />)}</Pie><Tooltip formatter={v => fmt(v)} contentStyle={tt} labelStyle={ttL} itemStyle={ttI} /></PieChart></ResponsiveContainer>}
      {invArr.map((inv, i) => { const a = D.gYTD > 0 ? inv.ytd / D.gYTD : 0; return <div key={i} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "8px 0", borderTop: i > 0 ? `1px solid ${T.bSub}` : "none" }}><div style={{ display: "flex", alignItems: "center", gap: 8 }}><div style={{ width: 8, height: 8, borderRadius: "50%", background: PC[i] }} /><span style={{ fontSize: 13 }}>{inv.name}</span></div><div style={{ textAlign: "right" }}><div style={{ fontSize: 14, fontWeight: 600 }}>{fmt(inv.ytd)}</div><div style={{ fontSize: 11, color: a >= inv.pctT ? T.green : T.amber }}>{pct(a)} / {pct(inv.pctT)}</div></div></div>; })}
    </Cd>

    <SH>Top Spending</SH>
    <Cd>{D.catArr.slice(0, 6).map((s, i) => <div key={i} style={{ marginBottom: i < 5 ? 12 : 0 }}><div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}><span style={{ fontSize: 13 }}>{s.cat}</span><span style={{ fontSize: 13, color: T.w3, fontWeight: 600 }}>{fmt(s.total)}</span></div><PB p={s.pct} color={PC[i]} /></div>)}</Cd>
  </div>;
}

function MonthlyTab({ D, pc, setModal }) {
  const active = D.monthly.filter(m => m.income > 0 || m.total > 0);
  const cd = active.map(m => ({ name: m.month, Fixed: m.fixed, Disc: m.disc, Invested: m.invested }));
  const trend = D.monthly.filter(m => m.income > 0).map(m => ({ name: m.month, Income: +m.income.toFixed(2), Spent: +m.total.toFixed(2), Invested: +m.invested.toFixed(2) }));
  return <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
    {trend.length > 1 && <><SH>Trend</SH><Cd sx={{ paddingRight: 8 }}><ResponsiveContainer width="100%" height={180}><LineChart data={trend}><CartesianGrid strokeDasharray="3 3" stroke={T.b} /><XAxis dataKey="name" tick={{ fill: T.w4, fontSize: 11 }} axisLine={{ stroke: T.b }} /><YAxis tick={{ fill: T.w4, fontSize: 10 }} axisLine={{ stroke: T.b }} tickFormatter={v => `$${v}`} width={50} /><Tooltip contentStyle={tt} labelStyle={ttL} itemStyle={ttI} formatter={v => fmt(v)} /><Legend wrapperStyle={{ fontSize: 11 }} /><Line type="monotone" dataKey="Income" stroke={T.w} strokeWidth={2} dot={{ r: 3 }} /><Line type="monotone" dataKey="Spent" stroke={T.red} strokeWidth={2} dot={{ r: 3 }} /><Line type="monotone" dataKey="Invested" stroke={T.green} strokeWidth={2} dot={{ r: 3 }} /></LineChart></ResponsiveContainer></Cd></>}
    <SH>Breakdown</SH>
    {cd.length > 0 && <Cd sx={{ paddingRight: 8 }}><ResponsiveContainer width="100%" height={180}><BarChart data={cd} barCategoryGap="25%"><CartesianGrid strokeDasharray="3 3" stroke={T.b} /><XAxis dataKey="name" tick={{ fill: T.w4, fontSize: 11 }} axisLine={{ stroke: T.b }} /><YAxis tick={{ fill: T.w4, fontSize: 10 }} axisLine={{ stroke: T.b }} tickFormatter={v => `$${v}`} width={50} /><Tooltip contentStyle={tt} labelStyle={ttL} itemStyle={ttI} formatter={v => fmt(v)} /><Legend wrapperStyle={{ fontSize: 11 }} /><Bar dataKey="Invested" fill={T.green} radius={[3, 3, 0, 0]} /><Bar dataKey="Fixed" fill={T.blue} radius={[3, 3, 0, 0]} /><Bar dataKey="Disc" fill={T.orange} radius={[3, 3, 0, 0]} /></BarChart></ResponsiveContainer></Cd>}
    {D.monthly.map((m, mi) => {
      if (m.income === 0 && m.total === 0) return null;
      const mPC = pc.filter(p => mIdx(p.date) === mi && p.gross > 0);
      return <Cd key={mi}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}><span style={{ fontSize: 16, fontWeight: 700 }}>{m.month}</span><span style={{ fontSize: 11, padding: "3px 10px", borderRadius: 20, background: m.total > m.income ? T.redDim : T.greenDim, color: m.total > m.income ? T.red : T.green, fontWeight: 600 }}>{m.total > m.income ? "Over" : "Under"}</span></div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
          {[["Income", m.income, T.w], ["Invested", m.invested, T.green], ["Fixed", m.fixed, T.blue], ["Disc.", m.disc, T.orange], ["Total Spent", m.total, T.red], ["Cash Flow", m.cf, m.cf >= 0 ? T.green : T.red]].map(([l, v, c], j) =>
            <div key={j} style={{ padding: "8px 10px", background: T.bg, borderRadius: 10 }}><div style={{ fontSize: 10, color: T.w4 }}>{l}</div><div style={{ fontSize: 14, fontWeight: 700, color: c, marginTop: 2 }}>{fmt(v)}</div></div>
          )}
        </div>
        {mPC.length > 0 && <div style={{ marginTop: 10 }}>{mPC.map(p => <div key={p.id} onClick={() => setModal({ t: "ePC", d: p })} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "12px 12px", background: T.bg, borderRadius: 10, marginBottom: 4, cursor: "pointer", minHeight: 48, touchAction: "manipulation" }}><span style={{ fontSize: 12, color: T.w3 }}>{dFmt(p.date)} · PP{p.period}</span><span style={{ fontSize: 13, fontWeight: 600, color: T.green }}>{fmt(p.gross)}</span></div>)}</div>}
      </Cd>;
    })}
    <Cd sx={{ border: `1px solid ${T.blue}30` }}>
      <div style={{ fontSize: 13, fontWeight: 700, color: T.blue, marginBottom: 8 }}>YTD Total</div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>{[["Income", D.gYTD], ["Invested", D.tInv], ["Spent", D.tSp], ["Cash Flow", D.nCF]].map(([l, v], i) => <div key={i} style={{ textAlign: "center", padding: 6 }}><div style={{ fontSize: 10, color: T.w4 }}>{l}</div><div style={{ fontSize: 15, fontWeight: 700 }}>{fmt(v)}</div></div>)}</div>
    </Cd>
  </div>;
}

function PayPeriodTab({ ppData, setModal }) {
  const active = ppData.filter(p => p.gross > 0);
  const cd = active.map(p => ({ name: `PP${p.period}`, Budget: +p.discBudget.toFixed(2), Spent: +p.discS.toFixed(2), Remaining: +p.discRemaining.toFixed(2) }));
  return <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
    <SH>Pay Period Overview</SH>
    {cd.length > 0 && <Cd sx={{ paddingRight: 8 }}>
      <ResponsiveContainer width="100%" height={180}><BarChart data={cd} barCategoryGap="20%"><CartesianGrid strokeDasharray="3 3" stroke={T.b} /><XAxis dataKey="name" tick={{ fill: T.w4, fontSize: 11 }} axisLine={{ stroke: T.b }} /><YAxis tick={{ fill: T.w4, fontSize: 10 }} axisLine={{ stroke: T.b }} tickFormatter={v => `$${v}`} width={55} /><Tooltip contentStyle={tt} labelStyle={ttL} itemStyle={ttI} formatter={v => fmt(v)} /><Legend wrapperStyle={{ fontSize: 11 }} /><Bar dataKey="Budget" fill={T.blue} radius={[3, 3, 0, 0]} /><Bar dataKey="Spent" fill={T.orange} radius={[3, 3, 0, 0]} /></BarChart></ResponsiveContainer>
      <ResponsiveContainer width="100%" height={80}><AreaChart data={cd}><XAxis dataKey="name" tick={{ fill: T.w4, fontSize: 10 }} axisLine={{ stroke: T.b }} /><YAxis tick={{ fill: T.w4, fontSize: 10 }} axisLine={{ stroke: T.b }} tickFormatter={v => `$${v}`} width={55} /><Tooltip contentStyle={tt} labelStyle={ttL} itemStyle={ttI} formatter={v => fmt(v)} /><Area type="monotone" dataKey="Remaining" stroke={T.green} fill={T.green} fillOpacity={0.1} strokeWidth={2} /></AreaChart></ResponsiveContainer>
    </Cd>}
    {active.map((pp, i) => {
      const over = pp.discS > pp.discBudget;
      return <Cd key={pp.id}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 8 }}><span style={{ fontSize: 16, fontWeight: 700 }}>PP{pp.period}</span><span style={{ fontSize: 11, padding: "3px 10px", borderRadius: 20, background: over ? T.redDim : T.greenDim, color: over ? T.red : T.green, fontWeight: 600 }}>{over ? "Over" : "Under"}</span></div>
          <span style={{ fontSize: 12, color: T.w4 }}>{dFmt(pp.date)}</span>
        </div>
        <div onClick={() => setModal({ t: "ePC", d: pp })} style={{ cursor: "pointer", padding: "12px 14px", background: T.bg, borderRadius: 10, marginBottom: 10, display: "flex", justifyContent: "space-between", alignItems: "center", minHeight: 48, touchAction: "manipulation" }}><span style={{ fontSize: 12, color: T.w3 }}>Gross Pay</span><span style={{ fontSize: 14, fontWeight: 700 }}>{fmt(pp.gross)}</span></div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 10 }}>
          {[["Invested", pp.totInv, T.green], ["Fixed", pp.fixS, T.blue], ["Disc Budget", pp.discBudget, T.w], ["Disc Spent", pp.discS, T.orange]].map(([l, v, c], j) =>
            <div key={j} style={{ padding: "8px 10px", background: T.bg, borderRadius: 10 }}><div style={{ fontSize: 10, color: T.w4 }}>{l}</div><div style={{ fontSize: 14, fontWeight: 700, color: c, marginTop: 2 }}>{fmt(v)}</div></div>
          )}
        </div>
        <div style={{ padding: "10px 14px", background: T.bg, borderRadius: 10, display: "flex", justifyContent: "space-between", alignItems: "center", border: `1px solid ${pp.discRemaining >= 0 ? T.green : T.red}20` }}>
          <span style={{ fontSize: 12, color: T.w3 }}>Running Remaining</span>
          <span style={{ fontSize: 18, fontWeight: 800, color: pp.discRemaining >= 0 ? T.green : T.red }}>{fmt(pp.discRemaining)}</span>
        </div>
        {pp.periodSpend.length > 0 && <details style={{ marginTop: 10 }}><summary style={{ fontSize: 12, color: T.blue, cursor: "pointer", fontWeight: 600 }}>{pp.periodSpend.length} transactions</summary>
          <div style={{ marginTop: 6 }}>{pp.periodSpend.sort((a, b) => a.date.localeCompare(b.date)).map((e, j) =>
            <div key={e.id} onClick={() => setModal({ t: "eSP", d: e })} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "10px 8px", borderTop: j > 0 ? `1px solid ${T.bSub}` : "none", cursor: "pointer", fontSize: 12, minHeight: 44, touchAction: "manipulation" }}>
              <div><span style={{ fontWeight: 500 }}>{e.cat}</span><span style={{ color: T.w4, marginLeft: 6 }}>{dFmt(e.date)}</span></div>
              <span style={{ fontWeight: 600, color: e.amt < 0 ? T.green : T.w }}>{fmt(e.amt)}</span>
            </div>
          )}</div>
        </details>}
      </Cd>;
    })}
  </div>;
}

function SpendingTab({ D, sp, setModal, pc }) {
  const [filter, setFilter] = useState("All");
  const [search, setSearch] = useState("");
  const noWL = sp.filter(s => s.cat !== "Wins/Losses");
  const searched = search ? noWL.filter(e => (e.cat + " " + (e.note || "") + " " + e.date).toLowerCase().includes(search.toLowerCase())) : noWL;
  const filtered = filter === "All" ? searched : searched.filter(s => s.cat === filter);
  const sorted = [...filtered].sort((a, b) => b.date.localeCompare(a.date));
  const pieData = D.catArr.filter(s => s.total > 0).map(s => ({ name: s.cat, value: s.total }));
  return <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
    <div style={{ display: "flex", gap: 8 }}>
      <Cd sx={{ flex: 1, textAlign: "center", padding: 14 }}><div style={{ fontSize: 10, color: T.w4 }}>Total Spent</div><div style={{ fontSize: 18, fontWeight: 700, color: T.red, marginTop: 2 }}>{fmt(D.tSp)}</div></Cd>
      <Cd sx={{ flex: 1, textAlign: "center", padding: 14 }}><div style={{ fontSize: 10, color: T.w4 }}>Wins/Losses</div><div style={{ fontSize: 18, fontWeight: 700, color: D.wl >= 0 ? T.green : T.red, marginTop: 2 }}>{fmt(D.wl)}</div></Cd>
    </div>
    {pieData.length > 0 && <Cd>
      <ResponsiveContainer width="100%" height={180}><PieChart><Pie data={pieData} cx="50%" cy="50%" innerRadius={48} outerRadius={78} dataKey="value" stroke="none" paddingAngle={1.5}>{pieData.map((_, i) => <Cell key={i} fill={PC[i]} />)}</Pie><Tooltip formatter={v => fmt(v)} contentStyle={tt} labelStyle={ttL} itemStyle={ttI} /></PieChart></ResponsiveContainer>
      {D.catArr.filter(s => s.total > 0).map((s, i) => <div key={i} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "7px 0", borderTop: i > 0 ? `1px solid ${T.bSub}` : "none" }}><div style={{ display: "flex", alignItems: "center", gap: 8 }}><div style={{ width: 8, height: 8, borderRadius: 2, background: PC[i] }} /><span style={{ fontSize: 12 }}>{s.cat}</span></div><div><span style={{ fontSize: 13, fontWeight: 600 }}>{fmt(s.total)}</span><span style={{ fontSize: 11, color: T.w4, marginLeft: 6 }}>{pct(s.pct)}</span></div></div>)}
    </Cd>}
    <SH>Log</SH>
    <div style={{ position: "relative" }}><input value={search} onChange={e => setSearch(e.target.value)} placeholder="Search..." style={{ ...iS, paddingLeft: 36 }} /><span style={{ position: "absolute", left: 12, top: "50%", transform: "translateY(-50%)", fontSize: 14, color: T.w4 }}>⌕</span></div>
    <div style={{ display: "flex", gap: 6, overflowX: "auto", scrollbarWidth: "none", WebkitOverflowScrolling: "touch", paddingBottom: 4 }}>
      {["All", ...CATS.filter(c => c !== "Wins/Losses")].map(c => <button key={c} onClick={() => setFilter(c)} style={{ padding: "8px 14px", borderRadius: 8, border: "none", fontSize: 12, fontWeight: 600, cursor: "pointer", flexShrink: 0, background: filter === c ? T.w : "transparent", color: filter === c ? T.bg : T.w4, fontFamily: "inherit", minHeight: 40, touchAction: "manipulation" }}>{c}</button>)}
    </div>
    <Cd sx={{ padding: 10 }}>
      {sorted.length === 0 && <div style={{ padding: 20, textAlign: "center", color: T.w4, fontSize: 13 }}>No entries{search ? " matching search" : ""}</div>}
      {sorted.slice(0, 80).map((e, i) =>
        <div key={e.id} onClick={() => setModal({ t: "eSP", d: e })} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "12px 10px", borderTop: i > 0 ? `1px solid ${T.bSub}` : "none", cursor: "pointer", minHeight: 52, touchAction: "manipulation" }}>
          <div><div style={{ fontSize: 13, fontWeight: 500 }}>{e.cat}</div><div style={{ fontSize: 11, color: T.w4 }}>{dFmt(e.date)}{e.note ? ` · ${e.note}` : ""}</div></div>
          <span style={{ fontSize: 14, fontWeight: 600, color: e.amt < 0 ? T.green : T.w, flexShrink: 0, marginLeft: 8 }}>{fmt(e.amt)}</span>
        </div>
      )}
    </Cd>
  </div>;
}

function GoalsTab({ D, st }) {
  return <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
    <SH>Savings Goals</SH>
    {Object.entries(GL).map(([k, name], i) => {
      const target = st.goalTargets[k] || 0, current = D.inv[GIM[k]] || 0;
      const p = target > 0 ? current / target : 0;
      const color = p >= 1 ? T.green : p >= 0.25 ? T.blue : T.red;
      return <Cd key={i}>
        <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 10 }}><div style={{ fontSize: 15, fontWeight: 700 }}>{name}</div><span style={{ fontSize: 11, color: T.w4, background: T.bg, padding: "3px 10px", borderRadius: 8 }}>{p >= 1 ? "✓ Done" : "In Progress"}</span></div>
        <PB p={p} color={color} h={8} />
        <div style={{ display: "flex", justifyContent: "space-between", marginTop: 10 }}>
          <div><div style={{ fontSize: 10, color: T.w4 }}>Current</div><div style={{ fontSize: 15, fontWeight: 700, color }}>{fmt(current)}</div></div>
          <div style={{ textAlign: "center" }}><div style={{ fontSize: 10, color: T.w4 }}>Progress</div><div style={{ fontSize: 15, fontWeight: 700, color }}>{pct(p)}</div></div>
          <div style={{ textAlign: "right" }}><div style={{ fontSize: 10, color: T.w4 }}>Remaining</div><div style={{ fontSize: 15, fontWeight: 700, color: T.w3 }}>{fmt(Math.max(0, target - current))}</div></div>
        </div>
        <div style={{ fontSize: 11, color: T.w4, marginTop: 8, textAlign: "center" }}>Target: {fmt(target)}</div>
      </Cd>;
    })}
  </div>;
}

function BillsTab({ sub, setModal }) {
  const total = sub.reduce((s, x) => s + x.cost, 0);
  const grouped = {}; sub.forEach(s => { if (!grouped[s.cat]) grouped[s.cat] = []; grouped[s.cat].push(s); });
  return <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
    <button style={bS(T.s3, false, false, true)} onClick={() => setModal("addSub")}><span style={{ color: T.w2 }}>+ Add Subscription</span></button>
    <div style={{ display: "flex", gap: 8 }}>
      <Cd sx={{ flex: 1, textAlign: "center", padding: 14 }}><div style={{ fontSize: 10, color: T.w4 }}>Monthly</div><div style={{ fontSize: 18, fontWeight: 700, color: T.blue, marginTop: 2 }}>{fmt(total)}</div></Cd>
      <Cd sx={{ flex: 1, textAlign: "center", padding: 14 }}><div style={{ fontSize: 10, color: T.w4 }}>Annual</div><div style={{ fontSize: 18, fontWeight: 700, color: T.amber, marginTop: 2 }}>{fmt(total * 12)}</div></Cd>
    </div>
    {Object.entries(grouped).map(([cat, items], gi) => <Cd key={gi}>
      <div style={{ fontSize: 11, fontWeight: 700, color: T.w4, marginBottom: 10, letterSpacing: 1, textTransform: "uppercase" }}>{cat}</div>
      {items.map((s, i) => <div key={s.id} onClick={() => setModal({ t: "eSub", d: s })} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "12px 4px", borderTop: i > 0 ? `1px solid ${T.bSub}` : "none", cursor: "pointer", minHeight: 48, touchAction: "manipulation" }}>
        <span style={{ fontSize: 13 }}>{s.name}</span>
        <div style={{ textAlign: "right" }}><span style={{ fontSize: 14, fontWeight: 600 }}>{fmt(s.cost)}</span><span style={{ fontSize: 10, color: T.w4 }}>/mo</span></div>
      </div>)}
    </Cd>)}
  </div>;
}

function NetWorthTab({ nw, D, nwh, setModal }) {
  const aD = nw.assets.filter(a => a.bal > 0).map(a => ({ name: a.name, value: a.bal }));
  const lD = nw.liabilities.filter(l => l.bal > 0).map(l => ({ name: l.name, value: l.bal }));
  const hist = nwh.map(h => ({ date: dFmt(h.date), Assets: h.assets, Liabilities: h.liabilities, Net: h.net }));
  return <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
    <Cd sx={{ textAlign: "center" }}>
      <div style={{ fontSize: 11, color: T.w4, fontWeight: 600, letterSpacing: 1 }}>NET WORTH</div>
      <div style={{ fontSize: 32, fontWeight: 800, color: D.netW >= 0 ? T.green : T.red, letterSpacing: -1, marginTop: 4 }}>{fmt(D.netW)}</div>
      <div style={{ display: "flex", justifyContent: "center", gap: 28, marginTop: 12 }}>
        <div><div style={{ fontSize: 10, color: T.w4 }}>Assets</div><div style={{ fontSize: 16, fontWeight: 700, color: T.green }}>{fmt(D.tA)}</div></div>
        <div style={{ width: 1, background: T.b }} />
        <div><div style={{ fontSize: 10, color: T.w4 }}>Liabilities</div><div style={{ fontSize: 16, fontWeight: 700, color: T.red }}>{fmt(D.tL)}</div></div>
      </div>
    </Cd>
    {hist.length > 1 && <><SH>History</SH><Cd sx={{ paddingRight: 8 }}><ResponsiveContainer width="100%" height={180}><LineChart data={hist}><CartesianGrid strokeDasharray="3 3" stroke={T.b} /><XAxis dataKey="date" tick={{ fill: T.w4, fontSize: 10 }} axisLine={{ stroke: T.b }} /><YAxis tick={{ fill: T.w4, fontSize: 10 }} axisLine={{ stroke: T.b }} tickFormatter={v => `$${(v / 1000).toFixed(0)}k`} width={40} /><Tooltip contentStyle={tt} labelStyle={ttL} itemStyle={ttI} formatter={v => fmt(v)} /><Legend wrapperStyle={{ fontSize: 11 }} /><Line type="monotone" dataKey="Assets" stroke={T.green} strokeWidth={2} dot={{ r: 3 }} /><Line type="monotone" dataKey="Liabilities" stroke={T.red} strokeWidth={2} dot={{ r: 3 }} /><Line type="monotone" dataKey="Net" stroke={T.blue} strokeWidth={2.5} dot={{ r: 4 }} /></LineChart></ResponsiveContainer></Cd></>}
    {hist.length <= 1 && <Cd sx={{ textAlign: "center", padding: 20 }}><div style={{ fontSize: 13, color: T.w4 }}>History chart appears after your second balance update</div></Cd>}
    <div style={{ display: "flex", gap: 8 }}>
      {[[aD, "Assets", T.green, [T.green, T.cyan, T.blue, T.purple, T.amber]], [lD, "Liabilities", T.red, [T.red, T.orange, T.pink]]].map(([data, label, col, cols], idx) =>
        <Cd key={idx} sx={{ flex: 1, padding: 10 }}>
          {data.length > 0 && <ResponsiveContainer width="100%" height={110}><PieChart><Pie data={data} cx="50%" cy="50%" innerRadius={25} outerRadius={45} dataKey="value" stroke="none">{data.map((_, i) => <Cell key={i} fill={cols[i % cols.length]} />)}</Pie><Tooltip formatter={v => fmt(v)} contentStyle={tt} labelStyle={ttL} itemStyle={ttI} /></PieChart></ResponsiveContainer>}
          <div style={{ textAlign: "center", fontSize: 11, color: col, fontWeight: 600 }}>{label}</div>
        </Cd>
      )}
    </div>
    {[["assets", nw.assets, T.green, "Assets"], ["liabilities", nw.liabilities, T.red, "Liabilities"]].map(([kind, items, col, title]) =>
      <Cd key={kind}><div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}><span style={{ fontSize: 12, fontWeight: 700, color: col, letterSpacing: 0.5 }}>{title}</span><button style={bS(col, true, true)} onClick={() => setModal({ t: "eNW", items, kind })}>Edit</button></div>
        {items.map((a, i) => <div key={a.id} style={{ display: "flex", justifyContent: "space-between", padding: "8px 0", borderTop: i > 0 ? `1px solid ${T.bSub}` : "none" }}><span style={{ fontSize: 13 }}>{a.name}</span><span style={{ fontSize: 14, fontWeight: 600, color: a.bal > 0 ? col : T.w4 }}>{fmt(a.bal)}</span></div>)}
        <div style={{ display: "flex", justifyContent: "space-between", paddingTop: 8, borderTop: `1px solid ${T.b}`, marginTop: 4 }}><span style={{ fontWeight: 700 }}>Total</span><span style={{ fontWeight: 700, color: col }}>{fmt(items.reduce((s, a) => s + a.bal, 0))}</span></div>
      </Cd>
    )}
  </div>;
}

function SettingsTab({ st, sST, exportJSON, exportCSV }) {
  const [pcts, setPcts] = useState({ ...st.investPcts });
  const [goals, setGoals] = useState({ ...st.goalTargets });
  const [saved, setSaved] = useState(false);
  const [resetC, setResetC] = useState(false);
  const handleSave = () => { const p = {}, g = {}; Object.entries(pcts).forEach(([k, v]) => { p[k] = parseFloat(v) || 0; }); Object.entries(goals).forEach(([k, v]) => { g[k] = parseFloat(v) || 0; }); sST({ investPcts: p, goalTargets: g }); setSaved(true); setTimeout(() => setSaved(false), 2000); };
  const handleReset = () => { try { Object.values(K).forEach(k => localStorage.removeItem(k)); } catch {} window.location.reload(); };
  const totalPct = Object.values(pcts).reduce((s, v) => s + (parseFloat(v) || 0), 0);
  return <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
    <SH>Investment %</SH>
    <Cd>{IK.map(k => <div key={k} style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}><span style={{ fontSize: 13, minWidth: 80 }}>{IL[k]}</span><input value={pcts[k]} onChange={e => setPcts({ ...pcts, [k]: e.target.value })} type="number" step="0.01" style={{ ...iS, flex: 1 }} /><span style={{ fontSize: 11, color: T.w4, minWidth: 40 }}>{pct(parseFloat(pcts[k]) || 0)}</span></div>)}
      <div style={{ display: "flex", justifyContent: "space-between", paddingTop: 8, borderTop: `1px solid ${T.b}` }}><span style={{ fontSize: 13, fontWeight: 600 }}>Total</span><span style={{ fontSize: 14, fontWeight: 700, color: totalPct <= 1 ? T.green : T.red }}>{pct(totalPct)}</span></div>
    </Cd>
    <SH>Goal Targets</SH>
    <Cd>{Object.entries(GL).map(([k, label]) => <div key={k} style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}><span style={{ fontSize: 12, minWidth: 110 }}>{label}</span><input value={goals[k]} onChange={e => setGoals({ ...goals, [k]: e.target.value })} type="number" style={{ ...iS, flex: 1 }} /></div>)}</Cd>
    <button style={bS(T.green, false, false, true)} onClick={handleSave}>{saved ? "✓ Saved" : "Save Settings"}</button>
    <SH>Export</SH>
    <Cd><div style={{ fontSize: 12, color: T.w3, marginBottom: 12 }}>Download for backup or spreadsheet sync.</div><div style={{ display: "flex", gap: 10 }}><button style={bS(T.blue, true, false, true)} onClick={exportJSON}>JSON</button><button style={bS(T.purple, true, false, true)} onClick={exportCSV}>CSV</button></div></Cd>
    <SH>Reset</SH>
    <Cd sx={{ borderColor: T.red + "20" }}><div style={{ fontSize: 12, color: T.w3, marginBottom: 10 }}>Restore original spreadsheet data. Cannot be undone.</div>
      {!resetC ? <button style={bS(T.red, true, false, true)} onClick={() => setResetC(true)}>Reset All Data</button> : <div style={{ display: "flex", gap: 10 }}><button style={bS(T.s3, true, false, true)} onClick={() => setResetC(false)}>Cancel</button><button style={bS(T.red, false, false, true)} onClick={handleReset}>Confirm</button></div>}
    </Cd>
  </div>;
}


ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(() => {}); }
</script>
</body>
</html>